{% extends "registration/base.html" %}

{% block card_content %}

<p class="title">
    T.H.E.N.A.
</p>
<p class="subtitle">
The Human Economic Negotiating Adjuster
</p>

<form method="post">
    {% csrf_token %}

    <p>Let's find your accessible price!</p>
    <p>Your order total is $<span id="max_price"></span>.</p>
    <p>Your order is eligible for up to $<span id="ap_eligible_amount"></span> in accessible pricing discounts.</p>
    <p>The least you might pay is $<span id="min_price"></span>.</p>
    <br>

    <p class="notification is-primary is-light has-text-centered" id="quote_box">
        Use the controls below to tell me what you think of each price and together. 
        We will find something that works for you.
        <br>
        If you want to start over, just refresh the page.
    </p>

    <div class="level notification">
        <p class="is-size-5 has-text-success">
            <span class="tag is-success">MIN</span><br>
            <span id="search_min">$</span>
        </p>
        <p id="test_price" class="is-size-3">$0</p>
        <p class="is-size-5 has-text-danger">
            <span class="tag is-danger">MAX</span><br>
            <span id="search_max">$</span>
        </p>
    </div>
    <input type="hidden" id="price_submit" name="price_submit" value="0">

    <div class="buttons level">
        <button type="button" class="button is-danger" onclick=PriceDecrease()>I could not pay this price.</button>
        <button type="submit" class="button is-link" name="ready_to_pay" id="ready_to_pay" title="Find your price first!" disabled>I'm ready to pay!</button>
        <button type="button" class="button is-success" onclick=PriceIncrease()>I could comfortably pay this price.</button>
    </div>

    <div class="buttons">
        {% include "utils/button.html" with button=view.previous_button %}
    </div>
</form>

<script>

    var step_size = 5;
    
    var max_price = Math.floor(({{ view.order.original_price }}) / 100 / step_size) * step_size;
    var ap_eligible_amount = Math.floor(({{ view.order.ap_eligible_amount }}) / 100 / step_size) * step_size;
    var min_price = max_price - ap_eligible_amount;

    var search_min = min_price;
    var search_max = max_price;
    var search_mid = null;
    var price_found = false;

    var display_mid = 0;

    var price_element = document.getElementById("test_price");
    var min_element = document.getElementById("search_min");
    var max_element = document.getElementById("search_max");
    var pay_element = document.getElementById("ready_to_pay");
    var price_submit_element = document.getElementById("price_submit");

    window.onload = function() {
        document.getElementById("max_price").textContent = max_price;
        document.getElementById("min_price").textContent = min_price;
        document.getElementById("ap_eligible_amount").textContent = ap_eligible_amount;

        SeekPrice(); // Shows initial middle value
        min_element.textContent = "$" + min_price;
        max_element.textContent = "$" + max_price;
    }

    function PriceDecrease() {
        search_max = search_mid;
        SeekPrice(-1);
        LoadQuote();
    }

    function PriceIncrease() {
        search_min = search_mid;
        SeekPrice(1);
        LoadQuote();
    }

    function SeekPrice(step_sign) {
        if (!price_found) {
            search_mid = Math.floor((search_min + search_max) / 2 / step_size) * step_size;
            if(search_mid == search_min && search_mid == search_max - step_size) {
                SetPriceFound();
            }
        } else {
            search_mid += step_sign * step_size;
            search_mid = Math.min(search_mid, max_price);
            search_mid = Math.max(search_mid, min_price);
            search_min = search_mid;
            search_max = search_mid;
        }
        min_element.textContent = "$" + search_min;
        max_element.textContent = "$" + search_max;
        price_submit_element.setAttribute("value", "" + search_mid * 100);
        AnimatePrice();
    }

    function SetPriceFound() { // call once when price is found
        price_found = true;
        pay_element.removeAttribute("disabled");
        pay_element.setAttribute("title", "You can continue to fine tune your price.");
    }

    async function AnimatePrice() {
        while(display_mid != search_mid) {
            display_mid += Math.sign(search_mid - display_mid);
            price_element.textContent = "$" + display_mid;
            await new Promise(r => setTimeout(r, 10));
        }
    }


    // Code for updating quote box
    var quote_element = document.getElementById("quote_box");
    var quote_index = 0;
    var quote_list = ["Looking forward to seeing you!",
                      "Make sure you pick a price that you're totally comfortable with.",
                      "I can't wait to dance with you!",
                      "You are amazing!",
                      "<3 <3 <3",
                      "Zach May will pun for you.",
                      "See your cute face on the dance floor.",
                      "We can't wait to hug you (with consent).",
                      "Not quite the right price? Zach May punderstands.",
                      "So excite. Much affordable price. Yasss.",
                      "Heckin' yeah!",
                      ];

    function LoadQuote() {
        quote_element.textContent = quote_list[quote_index];
        quote_index = (quote_index + 1) % quote_list.length;
    }

</script>

{% endblock %}