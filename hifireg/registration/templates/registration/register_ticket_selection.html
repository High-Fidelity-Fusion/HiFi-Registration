{% extends "registration/base.html" %}


{% block content %}
<p>Choose your tickets!</p>
{% for category in categories %}
<h3 class="title">{{category.name}}</h3>
  {% for slot in category.slots %}
  <h4 class="title is-4">{{slot.name}}</h4>
    {% for product in slot.products %}
      {% include 'registration/product_card.html' %}
    {% endfor %}
  {% endfor %}

  {% for product in category.products %}
    {% include 'registration/product_card.html' %}
  {% endfor %}
{% endfor %}
<form method="post">
  {% csrf_token %}

  <div class="control">
    <button type="submit" name='previous' class="button is-link">Previous</button>
    <button type="submit" name='next' class="button is-link">Next</button>
  </div>

</form>
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<style>
  .conflict {
    background: grey;
  }
</style>
<script>
  $(".product-checkbox").change(function() {
    var thisCheckBox = this;
    $('input').addClass('call-in-progress');
    var productId = this.dataset.product;
    var checkBoxes = $(`:input[data-product="${productId}"]`);
    checkBoxes.not(this).prop('checked', this.checked);
    $(thisCheckBox).parent().addClass("loading");

    if (this.checked) {
      $.ajax({
        url: '/registration/ajax/add_item/',
        data: {
          'product': productId,
          'increment': 1
        },
        dataType: 'json',
        success: function (data) {
          console.log(data);
          if (data.success) {
            var slots = thisCheckBox.dataset.slots.split(',');
            slots.forEach(slot => {
              var conflicts = $(`.slot-${slot}`).not(checkBoxes.parents());
              conflicts.addClass(`conflict-${slot}`);
            });

          } else {
            checkBoxes.prop('checked', !this.checked);
          }
          $('input').removeClass('call-in-progress');
          $(thisCheckBox).parent().removeClass("loading");
        }
      });
    } else {
      $.ajax({
        url: '/registration/ajax/remove_item/',
        data: {
          'product': productId,
          'decrement': 1
        },
        dataType: 'json',
        success: function (data) {
          console.log(data);


          var slots = thisCheckBox.dataset.slots.split(',');
          slots.forEach(slot => {
            var conflicts = $(`.conflict-${slot}`);
            conflicts.removeClass(`conflict-${slot}`);
          });

          $('input').removeClass('call-in-progress');
          $(thisCheckBox).parent().removeClass("loading");
        }
      });
    }
  });
</script>
{% endblock %}
